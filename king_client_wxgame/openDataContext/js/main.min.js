var egret=window.egret,__reflect=this&&this.__reflect||function(e,t,r){e.__class__=t,r?r.push(t):r=[t],e.__types__=e.__types__?r.concat(e.__types__):r},__extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var a in t)t.hasOwnProperty(a)&&(e[a]=t[a]);r.prototype=t.prototype,e.prototype=new r},Main=function(e){function t(){var t=e.call(this)||this;t._curPageIdx=1,t._pageCnt=6,t._resLoaded=!1,wx.onMessage(function(e){console.log("[subcontext] get cmd: ",e);var r=e.cmd;"display"==r?e.show?"friends"==e.type?t._fetchFriendsAndRun(e.openId):"group"==e.type&&t._fetchGroupInfoAndRun(e.openId,e.shareTicket):t._cancelGame():"pageUp"==r?t._onPageUp():"pageDown"==r&&t._onPageDown()});var r=new egret.ImageLoader;r.addEventListener(egret.Event.COMPLETE,function(e){var r=e.currentTarget;t._itemBgTexture=new egret.Texture,t._itemBgTexture._setBitmapData(r.data)},t),r.load("subcontextRes/item.png");var a=new egret.ImageLoader;a.addEventListener(egret.Event.COMPLETE,function(e){var r=e.currentTarget;t._itemTitleBgTexture=new egret.Texture,t._itemTitleBgTexture._setBitmapData(r.data)},t),a.load("subcontextRes/rankBg.png");var n=new egret.ImageLoader;n.addEventListener(egret.Event.COMPLETE,function(e){var r=e.currentTarget;t._itemStarTexture=new egret.Texture,t._itemStarTexture._setBitmapData(r.data)},t),n.load("subcontextRes/star.png");var i=new egret.ImageLoader;i.addEventListener(egret.Event.COMPLETE,function(e){var r=e.currentTarget;t._headIconFrontTexture=new egret.Texture,t._headIconFrontTexture._setBitmapData(r.data)},t),i.load("subcontextRes/headFront.png");var o=new egret.ImageLoader;return o.addEventListener(egret.Event.COMPLETE,function(e){var r=e.currentTarget;t._lineTexture=new egret.Texture,t._lineTexture._setBitmapData(r.data)},t),o.load("subcontextRes/line.png"),t._items=new Array,t}return __extends(t,e),t.prototype._fetchGroupInfoAndRun=function(e,t){var r=this;this._curPageIdx=1,wx.getGroupCloudStorage({shareTicket:t,keyList:["title","star","score"],success:function(t){r._friendData=t.data,r._sortFriendData(),r._runGame(e)},fail:function(e){console.log(e)},complete:function(e){}})},t.prototype._fetchFriendsAndRun=function(e){var t=this;this._curPageIdx=1,wx.getFriendCloudStorage({keyList:["title","star","score"],success:function(r){console.log(JSON.stringify(r.data)),t._friendData=r.data,t._sortFriendData(),t._runGame(e)},fail:function(e){console.log(e)},complete:function(){}})},t.prototype._sortFriendData=function(){this._friendData=this._friendData.sort(function(e,t){var r=e.KVDataList,a=0;r.forEach(function(e){"score"==e.key&&(a=parseInt(e.value))});var n=t.KVDataList,i=0;return n.forEach(function(e){"score"==e.key&&(i=parseInt(e.value))}),a>i?-1:1})},t.prototype._removeItems=function(){this._items.forEach(function(e){e.parent&&e.parent.removeChild(e)}),this._items=new Array},t.prototype._onPageUp=function(){var e=this._curPageIdx+1;this._pageCnt*(e-1)>=this._friendData.length||(this._curPageIdx=e,this._removeItems(),this._drawRankList())},t.prototype._onPageDown=function(){var e=this._curPageIdx-1;0>=e||(this._curPageIdx=e,this._removeItems(),this._drawRankList())},t.prototype._drawOneInfo=function(e,t,r,a){var n=this,i="",o=0,s=e.KVDataList;s.forEach(function(e){"star"==e.key?o=parseInt(e.value):"title"==e.key&&(i=e.value)});var d=new egret.DisplayObjectContainer;d.y=r,this.addChild(d);var g=new egret.Bitmap(this._itemBgTexture);g.width=389,g.height=64,d.addChild(g);var h=new egret.TextField;h.x=10,h.y=12,h.width=40,h.height=40,h.text=""+a,h.size=30,h.stroke=2,h.strokeColor=0,h.textColor=16777215,h.verticalAlign=egret.VerticalAlign.MIDDLE,h.textAlign=egret.HorizontalAlign.CENTER,d.addChild(h);var _=new egret.ImageLoader;_.addEventListener(egret.Event.COMPLETE,function(e){var t=e.currentTarget,r=new egret.Texture;r._setBitmapData(t.data);var a=new egret.Bitmap(r);a.width=50,a.height=50,a.x=57,a.y=6,d.addChild(a);var i=new egret.Bitmap(n._headIconFrontTexture);i.width=55,i.height=55,i.x=54,i.y=3,d.addChild(i)},this),_.load(e.avatarUrl);var c=new egret.TextField;c.x=113,c.y=12,c.width=200,c.height=40,c.text=e.nickname,c.size=18,c.textColor=0,c.verticalAlign=egret.VerticalAlign.MIDDLE,d.addChild(c);var u=new egret.Bitmap(this._itemTitleBgTexture);u.x=320,u.y=1,u.width=69,u.height=61,d.addChild(u);var l=new egret.Bitmap(this._itemStarTexture);l.x=353,l.y=10,l.width=25,l.height=24,d.addChild(l);var p=new egret.TextField;p.x=320,p.y=13,p.width=29,p.height=24,p.text=""+o,p.size=15,p.textColor=0,p.textAlign=egret.HorizontalAlign.RIGHT,p.verticalAlign=egret.VerticalAlign.MIDDLE,d.addChild(p);var f=new egret.TextField;return f.x=319,f.y=35,f.width=70,f.height=24,f.text=i,f.size=18,f.textColor=0,f.textAlign=egret.HorizontalAlign.CENTER,f.verticalAlign=egret.VerticalAlign.MIDDLE,d.addChild(f),d},t.prototype._drawRankList=function(){try{this._drawY=0;for(var e=(this._curPageIdx-1)*this._pageCnt;e<this._friendData.length&&e<this._curPageIdx*this._pageCnt;++e){var t=this._friendData[e];if(t){var r=this._drawOneInfo(t,0,this._drawY,e+1);this._drawY+=64,this._items.push(r)}}}catch(a){console.log("[subcontext] runGame error: ",a)}},t.prototype._drawSelfInfo=function(e){this._drawY=384,this._drawY+=5;var t=new egret.Bitmap(this._lineTexture);t.x=21,t.y=this._drawY,t.width=388,t.height=3,this.addChild(t);for(var r=0,a=null,n=0;n<this._friendData.length;++n){var i=this._friendData[n];if(i.openid==e){r=n+1,a=i;break}}this._drawY+=5,a&&this._drawOneInfo(a,0,this._drawY,r)},t.prototype._runGame=function(e){this._drawRankList(),this._drawSelfInfo(e)},t.prototype._cancelGame=function(){this._removeItems(),this.removeChildren()},t}(egret.DisplayObjectContainer);__reflect(Main.prototype,"Main"),window.Main=Main;